<html style="overflow: hidden;">
  <head>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
  </head>
  <body onload="resize()">
    <div class="inner-content">
    <form method="post" id="integration-form">
      {{{tpl}}}
      <input type="hidden" value="{{{token}}}" name="token" />
    </form>
  </div>
    <script>
      var form = document.getElementById('integration-form');

      (function () {
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          return false
        });

        window.addEventListener('message', function(event) {
          if (event.data.post_form) {
            var formData = new FormData(form);
            var action = form.getAttribute('action') || "";

            var object = {};
            formData.forEach(function(value, key){
                object[key] = value;
            });
            var json = JSON.stringify(object);

            fetch(action, {
              method: "POST",
              body: json,
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              }
            })
            .then(function(response) {
              response.json()
              .then((e) => {
                if ( e.success ) {
                  sendSavedToParent()
                } else if (!e.success) {
                  showError(e.error)
                } else {
                  showError("An error occured")
                }
              })
              .catch((e) => {
                showError(e)
              })
            })
            .catch(function(error) {
              showError(e)
            });

            return false;
          }
        })

        const showError = (error) => {
          window.parent.postMessage({'iframe_saved': {success: false}}, "*");
        }

        const sendSavedToParent = () => {
          window.parent.postMessage({'iframe_saved': {success: true}}, "*");
        }
      })()

      const resize = () => {
        setTimeout(function() {
          window.parent.postMessage({'iframe_loaded': {height: form.clientHeight}}, "*");
        }, 100)
      }
    </script>
  </body>
</html>
